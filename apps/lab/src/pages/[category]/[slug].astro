---
import { existsSync, readFileSync } from "node:fs";
import path from "node:path";
import fg from "fast-glob";
import matter from "gray-matter";
import { SITE_URLS } from "../../lib/urls";
import "../../styles/global.css";

export async function getStaticPaths() {
  const CONTENT_DIR = path.resolve(process.cwd(), "../../packages/content");
  const files = await fg(path.join(CONTENT_DIR, "resources/*/index.mdx"));

  const paths = [];

  for (const file of files) {
    const raw = readFileSync(file, "utf-8");
    const { data } = matter(raw);

    if (!data.labRoute) continue;

    // labRoute is like "/web-animations/scroll-fade"
    const parts = data.labRoute.replace(/^\//, "").split("/");
    if (parts.length < 2) continue;

    const [category, slug] = parts;

    // Read snippets
    const snippetsDir = path.join(CONTENT_DIR, `resources/${data.slug}/snippets`);
    const htmlPath = path.join(snippetsDir, "html.html");
    const cssPath = path.join(snippetsDir, "style.css");
    const jsPath = path.join(snippetsDir, "script.js");

    const html = existsSync(htmlPath) ? readFileSync(htmlPath, "utf-8") : null;
    const css = existsSync(cssPath) ? readFileSync(cssPath, "utf-8") : null;
    const js = existsSync(jsPath) ? readFileSync(jsPath, "utf-8") : null;

    paths.push({
      params: { category, slug },
      props: { meta: data, html, css, js },
    });
  }

  return paths;
}

const { meta, html, css, js } = Astro.props;

// Build the srcdoc — inline CSS and JS into the HTML
let srcdoc = html ?? "";

if (css && srcdoc) {
  srcdoc = srcdoc.replace(
    /<link[^>]*href=["'](?:\.\/)?style\.css["'][^>]*>/i,
    `<style>${css}</style>`
  );
}

if (js && srcdoc) {
  // Preserve module semantics for demos that rely on ESM imports.
  srcdoc = srcdoc.replace(
    /<script([^>]*)src=["'](?:\.\/)?script\.js["']([^>]*)><\/script>/i,
    (_match, before, after) => {
      const attrs = `${before ?? ""} ${after ?? ""}`;
      const isModule = /\btype\s*=\s*["']module["']/i.test(attrs);
      return isModule ? `<script type="module">${js}</script>` : `<script>${js}</script>`;
    }
  );
}

const wwwUrl = `${SITE_URLS.www}/r/${meta.slug}`;
const description = meta.description ?? "Runnable lab demo from StealThis.dev resources.";
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content={description} />
  <meta name="robots" content="noindex, follow" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="canonical" href={wwwUrl} />
  <meta property="og:title" content={`${meta.title} — Lab — StealThis.dev`} />
  <meta property="og:description" content={description} />
  <meta property="og:type" content="website" />
  <meta property="og:url" content={wwwUrl} />
  <meta property="og:image" content="https://stealthis.dev/social-card.webp" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={`${meta.title} — Lab — StealThis.dev`} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content="https://stealthis.dev/social-card.webp" />
  <title>{meta.title} — Lab — StealThis.dev</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #0f172a; }
    .lab-overlay {
      position: fixed; top: 1rem; right: 1rem; z-index: 100;
      display: flex; align-items: center; gap: 0.5rem;
      opacity: 0.3; transition: opacity 0.2s ease;
    }
    .lab-overlay:hover { opacity: 1; }
    .lab-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      font-size: 0.75rem; font-weight: 600; font-family: system-ui, sans-serif;
      padding: 0.5rem 0.875rem; border-radius: 0.625rem;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(15,23,42,0.85); backdrop-filter: blur(12px);
      color: #94a3b8; cursor: pointer; text-decoration: none;
      transition: color 0.2s ease, background 0.2s ease;
    }
    .lab-btn:hover { color: #f1f5f9; background: rgba(30,41,59,0.95); }
    iframe { width: 100vw; height: 100vh; border: none; display: block; }
  </style>
</head>
<body>
  <!-- Overlay controls -->
  <div class="lab-overlay">
    <span style="color:#475569;font-size:0.7rem;font-family:system-ui">
      {meta.title}
    </span>
    <a href={wwwUrl} target="_blank" rel="noopener" class="lab-btn">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
      </svg>
      View Code
    </a>
    <a href="/" class="lab-btn">
      ← Lab
    </a>
  </div>

  <!-- Demo in sandboxed iframe -->
  {srcdoc ? (
    <iframe
      srcdoc={srcdoc}
      title={`${meta.title} demo`}
      sandbox="allow-scripts allow-same-origin"
      loading="lazy"
    />
  ) : (
    <div style="display:grid;place-items:center;height:100vh;color:#475569;font-family:system-ui">
      No HTML demo available for this resource.
    </div>
  )}
</body>
</html>
